<!doctype html>
<head>
<meta http-equiv="Cache-Control" content="no-cache">
<script src="/system/scripts/jquery/jquery-1.12.4.min.js"></script>
<style>
* {
	font-family:sans-serif;
}

body { margin: 0; padding: 0; }

.header {
	background-color:#6dac20;
	color:white;
	width:100%;
	height:42px;
	text-align:center;
}

.lastlines {
	font-family:monospace;
}
</style>


</head>

<body>
<div class="header">
	<div style="padding:13px"><b>LoxBerry Update</b></div>
</div>
<br>
<center>
<h2>An update is running. Please be patient - this can take a really long time...</h2>
<br>
<img src="/updatereboot-anim-large.gif">
<br>
<table width="60%">
<tr><td>
I'm serious - this really can take a <b>long</b> time - especially if you are using older hardware! We currently install a bigger update. Take a beer/coffee (or two) and relax ;-) The webinterface will be back as soon as the update has been completed.
<br><br>
Your LoxBerry.
</td></tr>
</table>
<a href="/logfile" target="_blank">Logfile</a>
<br><br>
<h4>Last lines of logfile</h4>
<table id="lastlines" class="lastlines" style="width:80%;font-family:monospace">
</table>

</center>
</body>
</html>

<script>

var requestRunning = 0;
	
$(function() {
    refreshLastlines();
	var refreshTimer = setInterval(refreshLastlines, 3000);
	console.log( "Page loaded" );
	
});
	
function refreshLastlines() {
	console.log("refreshLastlines");
	if (requestRunning != 0) 
		return;
	console.log("getJSON");
	requestRunning = 1;
	$.getJSON( "/lastlines", function( data ) {
		var items = [];
		console.log(data);
		
		$.each( data.entries, function( key, val ) {
			items.push( "<tr><td class='lastlines'>"+escapeHtml(val)+"</td></tr>" );
		});
		$( "#lastlines" ).html (items.join( "" ));
			
	})
	.fail(function( jqxhr, textStatus, error ) { 
		$( "#lastlines" ).html ("(Currently not available, possibly rebooting.)");
		console.log(jqxhr.status, jqxhr.statusText);
		if( jqxhr.status === 404 ) {
			console.log("Status is 404");
			window.open(location.protocol + '//' + location.host, '_top');
		}
	
	})
	.always(function() {
		requestRunning=0;
	});
	
}

var entityMap = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#39;',
  '/': '&#x2F;',
  '`': '&#x60;',
  '=': '&#x3D;'
};

function escapeHtml (string) {
  return String(string).replace(/[&<>"'`=\/]/g, function (s) {
    return entityMap[s];
  });
}


</script>
